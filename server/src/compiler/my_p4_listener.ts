import { P4Listener } from '../antlr_autogenerated/P4Listener';
import { logDebug, logInfo} from '../utils/logger';
import { P4IRTypes } from './p4_ir_types';
import { SymbolTable } from './symbol_table';
import { Attribute } from './p4_ir';
import { TextDocumentPositionParams, CompletionItem, CompletionItemKind } from 'vscode-languageserver';

export class MyP4Listener extends P4Listener{
	private sTable: SymbolTable;

	constructor(){
		super();
		P4Listener.call(this);
		this.sTable = new SymbolTable();
	}

	getAutoCompletions(keyword: string | null, pos: TextDocumentPositionParams): CompletionItem[] {
		return this.sTable.getAutoCompletion(keyword, pos);
	}

	enterProgram(ctx){
		this.sTable.push(ctx, P4IRTypes.P4_PROGRAM, null);
	}

	exitProgram(ctx){
		this.sTable.pop();
	}

	enterTableDeclaration(ctx){
		let attr: Attribute | null = null;
		if(ctx.name() != null)
			attr = new Attribute(ctx.name().getText(), P4IRTypes.TABLE, CompletionItemKind.Class, ctx);
		this.sTable.push(ctx, P4IRTypes.TABLE, attr);
	}

	exitTableDeclaration(ctx){
		this.sTable.pop();
	}

	enterConstantDeclaration(ctx) {
		let name: string = ctx.name().getText();
		let type: string = ctx.typeRef().getText();
		let attr: Attribute = new Attribute(name, type, CompletionItemKind.Constant , ctx);
		this.sTable.add_attr(attr);
	}

	enterParameter(ctx) {
		let name: string = ctx.name().getText();
		let type: string = ctx.typeRef().getText();
		let attr: Attribute = new Attribute(name, type, CompletionItemKind.Variable, ctx);
		this.sTable.add_attr(attr);
	}
}